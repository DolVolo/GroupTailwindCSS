<!--บันทึกเกรดรายบุคคล-->
<!DOCTYPE html>
<html lang="th">
<head>
    <!-- ส่วนหัวของเอกสาร HTML กำหนดข้อมูลพื้นฐานของหน้าเว็บ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกเกรดรายบุคคล - ระบบจัดการการเรียนการสอน</title>
    
    <!-- นำเข้า CSS Framework และ Library ต่างๆ -->
    <script src="https://cdn.tailwindcss.com"></script> <!-- Tailwind CSS สำหรับจัดการสไตล์ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script> <!-- Lucide Icons สำหรับไอคอน -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <!-- XLSX สำหรับอ่านไฟล์ Excel -->
    <script src="data.js"></script> <!-- ไฟล์ข้อมูลรายวิชาและนักศึกษา -->
    
    <!-- สไตล์เพิ่มเติม -->
    <style>
        /* ซ่อนส่วนที่ไม่ต้องการเมื่อสั่งพิมพ์ */
        @media print {
            .no-print {
                display: none !important;
            }
        }
        /* ซ่อน input file เพื่อใช้ปุ่มกดแทน */
        .file-input {
            display: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-50">
    
    <!-- ส่วนหัวเว็บไซต์ (Navbar) - แถบเมนูด้านบน -->
    <header class="bg-green-800 text-white shadow-lg">
        <nav class="container mx-auto px-2 py-3">
            <!-- ส่วนหลักของ Navigation Bar จัดวางแบบ flex space-between -->
            <div class="flex justify-between items-center">
                <!-- ส่วนซ้าย: โลโก้และชื่อระบบ -->
                <div class="flex items-center space-x-2">
                    <!-- โลโก้มหาวิทยาลัย -->
                    <img src="https://upload.wikimedia.org/wikipedia/th/thumb/b/b7/MJU_LOGO.svg/1200px-MJU_LOGO.svg.png" 
                         alt="Maejo University" 
                         class="h-12" />
                    <!-- ชื่อระบบ (ซ่อนบนมือถือ แสดงบน tablet ขึ้นไป) -->
                    <div class="hidden md:flex flex-col">
                        <span class="font-bold text-lg">ระบบจัดการการเรียนการสอน</span>
                        <span class="text-sm">มหาวิทยาลัยแม่โจ้</span>
                    </div>
                </div>

                <!-- เมนูสำหรับหน้าจอขนาดใหญ่ (Desktop) - ซ่อนบนมือถือ -->
                <div class="hidden lg:flex items-center space-x-4">
                    <!-- กลุ่มเมนูหลัก -->
                    <div class="flex space-x-2">
                        <a href="mainpageprofessor.html" class="nav-link px-3 py-2 rounded hover:bg-green-700 transition">
                            หน้าหลัก
                        </a>
                        <a href="professorclass.html" class="nav-link px-3 py-2 rounded hover:bg-green-700 transition">
                            รายวิชาที่สอน
                        </a>
                        <a href="professorsavegrade.html" class="nav-link px-3 py-2 rounded bg-green-700 transition">
                            บันทึกเกรดรายบุคคล
                        </a>
                    </div>
                    <!-- เส้นแบ่งระหว่างเมนูและส่วนโปรไฟล์ -->
                    <div class="border-l border-green-600 h-8"></div>
                    <!-- ส่วนโปรไฟล์ผู้ใช้ (Dropdown) -->
                    <div class="relative">
                        <!-- ปุ่มแสดงโปรไฟล์ -->
                        <button id="profileDropdownBtn" class="flex items-center space-x-1 px-3 py-2 bg-green-700 rounded hover:bg-green-600 transition">
                            <i data-lucide="user" size="18"></i>
                            <span id="professorName">อาจารย์</span>
                            <i data-lucide="chevron-down" size="16"></i>
                        </button>
                        <!-- เมนู Dropdown ที่แสดงเมื่อคลิกปุ่มโปรไฟล์ -->
                        <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border hidden z-50">
                            <a href="#" onclick="navigateTo('profile')" class="block px-4 py-2 text-gray-700 hover:bg-green-50 rounded-t-lg">
                                <i data-lucide="user" size="16" class="inline mr-2"></i>
                                โปรไฟล์
                            </a>
                            <a href="#" onclick="logout()" class="block px-4 py-2 text-gray-700 hover:bg-green-50 rounded-b-lg">
                                <i data-lucide="log-out" size="16" class="inline mr-2"></i>
                                ออกจากระบบ
                            </a>
                        </div>
                    </div>
                </div>

                <!-- ปุ่มเมนูสำหรับมือถือ (แสดงเฉพาะบนหน้าจอเล็ก) -->
                <button id="mobileMenuBtn" class="lg:hidden p-2 rounded-md text-white hover:bg-green-700 focus:outline-none">
                    <i id="menuIcon" data-lucide="menu" size="24"></i>
                    <i id="closeIcon" data-lucide="x" size="24" class="hidden"></i>
                </button>
            </div>

            <!-- เมนูสำหรับมือถือ (แสดงเมื่อกดปุ่มเมนู) -->
            <div id="mobileMenu" class="lg:hidden mt-2 py-2 border-t border-green-700 hidden">
                <div class="flex flex-col space-y-1">
                    <a href="mainpageprofessor.html" class="mobile-nav-link px-3 py-2 rounded hover:bg-green-700 transition">
                        หน้าหลัก
                    </a>
                    <a href="professorclass.html" class="mobile-nav-link px-3 py-2 rounded hover:bg-green-700 transition">
                        รายวิชาที่สอน
                    </a>
                    <a href="professorsavegrade.html" class="mobile-nav-link px-3 py-2 rounded bg-green-700 transition">
                        บันทึกเกรดรายบุคคล
                    </a>
                    <a href="#" onclick="navigateTo('profile')" class="mobile-nav-link px-3 py-2 rounded hover:bg-green-700 transition">
                        โปรไฟล์
                    </a>
                    <div class="relative mt-2">
                        <button onclick="logout()" class="flex items-center space-x-1 px-3 py-2 bg-green-600 rounded hover:bg-green-700 transition w-full">
                            <i data-lucide="log-out" size="18"></i>
                            <span>ออกจากระบบ</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- ส่วนเนื้อหาหลัก -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- ส่วนหัวของหน้า: แสดงชื่อหน้าและปุ่มควบคุม -->
        <div class="flex justify-between items-center mb-6">
            <!-- ส่วนซ้าย: หัวข้อและชื่ออาจารย์ -->
            <div>
                <h1 class="text-3xl font-bold">บันทึกเกรดรายบุคคล</h1>
                <p id="professorNameDisplay" class="text-lg text-gray-600 mt-2"></p>
            </div>
            <!-- ส่วนขวา: ปุ่มพิมพ์และดาวน์โหลด (ซ่อนเมื่อสั่งพิมพ์) -->
            <div class="flex space-x-2 no-print">
                <button onclick="handlePrint()" class="flex items-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                    <i data-lucide="printer" size="18" class="mr-1"></i>
                    พิมพ์
                </button>
                <button onclick="handleDownload()" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i data-lucide="download" size="18" class="mr-1"></i>
                    ดาวน์โหลด PDF
                </button>
            </div>
        </div>

        <!-- ส่วนเลือกรายวิชา: ให้อาจารย์เลือกวิชาที่ต้องการบันทึกเกรด -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">เลือกรายวิชา</h2>
            <!-- จัดเรียงแบบ Grid: 1 คอลัมน์บนมือถือ, 2 คอลัมน์บนหน้าจอใหญ่ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">รายวิชาที่สอน</label>
                    <select id="courseSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="loadStudentList()">
                        <option value="">เลือกรายวิชา</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ภาคการศึกษา</label>
                    <select id="semesterSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="updateGradeColumns()">
                        <option value="semester1">ภาคเรียนที่ 1</option>
                        <option value="semester2">ภาคเรียนที่ 2</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ส่วนแสดงรายชื่อนักศึกษาและบันทึกเกรด (แสดงเมื่อเลือกรายวิชาแล้ว) -->
        <div id="studentGradeSection" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
            <!-- หัวตาราง: แสดงชื่อวิชาและรายละเอียด -->
            <div class="p-4 bg-green-700 text-white">
                <h2 class="text-xl font-bold" id="courseTitle">รายชื่อนักศึกษาและเกรด</h2>
                <p class="text-sm" id="courseDetails">ภาคการศึกษาที่ 1/2566</p>
            </div>
            <!-- ตารางรายชื่อนักศึกษา (รองรับการเลื่อนแนวนอนบนมือถือ) -->
            <div class="p-4 overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border p-3 text-left">ลำดับ</th>
                            <th class="border p-3 text-left">รหัสนักศึกษา</th>
                            <th class="border p-3 text-left">ชื่อ-นามสกุล</th>
                            <th class="border p-3 text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <span>เกรดภาคเรียนที่ 1</span>
                                    <button onclick="triggerFileUpload('semester1')" class="text-blue-600 hover:text-blue-800 transition" title="อัปโหลดไฟล์ Excel">
                                        <i data-lucide="file-spreadsheet" size="16"></i>
                                    </button>
                                </div>
                            </th>
                            <th class="border p-3 text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <span>เกรดภาคเรียนที่ 2</span>
                                    <button onclick="triggerFileUpload('semester2')" class="text-blue-600 hover:text-blue-800 transition" title="อัปโหลดไฟล์ Excel">
                                        <i data-lucide="file-spreadsheet" size="16"></i>
                                    </button>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <!-- รายชื่อนักศึกษาจะถูกเติมด้วย JavaScript -->
                    </tbody>
                </table>
            </div>
            <!-- ส่วนล่างตาราง: แสดงสรุปจำนวนนักศึกษาและเกรดที่ใช้ -->
            <div class="p-4 bg-gray-50 border-t">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        <span>จำนวนนักศึกษาทั้งหมด: <span id="totalStudents">0</span> คน</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span>เกรดที่ใช้: A, B+, B, C+, C, D+, D, F</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ส่วนแสดงสถิติเกรด: แสดงจำนวนนักศึกษาที่ได้เกรดแต่ละระดับ -->
        <div id="gradeStatsSection" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
            <h2 class="text-xl font-bold mb-4">สถิติเกรด</h2>
            <!-- จัดเรียงแบบ Grid: 2 คอลัมน์บนมือถือ, 4 คอลัมน์บน tablet, 8 คอลัมน์บนหน้าจอใหญ่ -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="gradeA">0</div>
                    <div class="text-sm text-gray-600">A</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-500" id="gradeBPlus">0</div>
                    <div class="text-sm text-gray-600">B+</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="gradeB">0</div>
                    <div class="text-sm text-gray-600">B</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-500" id="gradeCPlus">0</div>
                    <div class="text-sm text-gray-600">C+</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="gradeC">0</div>
                    <div class="text-sm text-gray-600">C</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600" id="gradeDPlus">0</div>
                    <div class="text-sm text-gray-600">D+</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-500" id="gradeD">0</div>
                    <div class="text-sm text-gray-600">D</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="gradeF">0</div>
                    <div class="text-sm text-gray-600">F</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Input file ที่ซ่อนไว้สำหรับอัปโหลดไฟล์ Excel -->
    <!-- ใช้สำหรับอัปโหลดเกรดภาคเรียนที่ 1 -->
    <input type="file" id="fileInput-semester1" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'semester1')">
    <!-- ใช้สำหรับอัปโหลดเกรดภาคเรียนที่ 2 -->
    <input type="file" id="fileInput-semester2" class="file-input" accept=".xlsx,.xls" onchange="handleFileUpload(event, 'semester2')">

    <!-- ส่วนท้ายเว็บไซต์ (Footer) -->
    <footer class="bg-green-800 text-white py-6">
        <div class="container mx-auto px-4">
            <!-- จัดเรียงแบบ flex: แนวตั้งบนมือถือ, แนวนอนบนหน้าจอใหญ่ -->
            <div class="flex flex-col md:flex-row justify-between">
                <div class="mb-4 md:mb-0">
                    <h3 class="font-bold text-lg mb-2">มหาวิทยาลัยแม่โจ้</h3>
                    <p class="text-sm">
                        63 หมู่ 4 ตำบลหนองหาร อำเภอสันทราย จังหวัดเชียงใหม่ 50290
                    </p>
                    <p class="text-sm">โทรศัพท์: 053-873000</p>
                </div>
                <div class="mb-4 md:mb-0">
                    <h3 class="font-bold text-lg mb-2">ติดต่อเรา</h3>
                    <p class="text-sm">สำนักบริหารและพัฒนาวิชาการ</p>
                    <p class="text-sm">โทรศัพท์: 053-873460</p>
                    <p class="text-sm">อีเมล: academic@mju.ac.th</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2">ช่วยเหลือ</h3>
                    <ul class="text-sm">
                        <li>
                            <a href="#" class="hover:underline">
                                คำถามที่พบบ่อย
                            </a>
                        </li>
                        <li>
                            <a href="#" class="hover:underline">
                                คู่มือการใช้งาน
                            </a>
                        </li>
                        <li>
                            <a href="#" class="hover:underline">
                                แจ้งปัญหาการใช้งาน
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-green-700 text-center text-sm">
                <p>
                    &copy; <span id="currentYear"></span> ระบบจัดการการเรียนการสอน
                    มหาวิทยาลัยแม่โจ้ สงวนลิขสิทธิ์
                </p>
            </div>
        </div>
    </footer>

    <script>
        // ตัวแปรสำหรับเก็บข้อมูลรายวิชาปัจจุบันและภาคเรียนที่เลือก
        let currentCourse = null; // รายวิชาที่เลือกในปัจจุบัน
        let currentSemester = 'semester1'; // ภาคเรียนที่เลือก (เริ่มต้นเป็นภาคเรียนที่ 1)

        // ฟังก์ชันดึงชื่ออาจารย์ที่ล็อกอินจาก localStorage
        function getLoggedInProfessor() {
            // ดึงข้อมูลจาก localStorage โดยลองหาจากหลายๆ key
            return localStorage.getItem('currentUser') || localStorage.getItem('selectedInstructor') || 'ไม่ระบุ';
        }

        // ฟังก์ชันอัปเดตการแสดงชื่ออาจารย์ในหน้าเว็บ
        function updateProfessorName() {
            const professorNameElement = document.getElementById('professorNameDisplay');
            const professorName = getLoggedInProfessor();
            professorNameElement.textContent = `อาจารย์: ${professorName}`;
        }

        // ฟังก์ชันตรวจสอบสถานะการล็อกอิน
        function checkLoginStatus() {
            const userType = localStorage.getItem('userType'); // ประเภทผู้ใช้
            const username = getLoggedInProfessor(); // ชื่อผู้ใช้
            
            // ตรวจสอบว่าเป็นอาจารย์หรือไม่
            if (userType !== 'teacher') {
                alert('กรุณาเข้าสู่ระบบในฐานะอาจารย์');
                window.location.href = 'login.html';
                return false;
            }
            
            // ตั้งค่าชื่อในแถบเมนูให้เป็น "อาจารย์" เพื่อความสม่ำเสมอ
            const professorNameElement = document.getElementById('professorName');
            if (professorNameElement) {
                professorNameElement.textContent = 'อาจารย์';
            }
            
            // อัปเดตการแสดงชื่ออาจารย์ในเนื้อหาหลัก
            updateProfessorName();
            
            return true;
        }

        // ฟังก์ชันโหลดรายวิชาที่อาจารย์ที่ล็อกอินสอน
        function loadProfessorCourses() {
            const username = getLoggedInProfessor();
            if (!username || username === 'ไม่ระบุ') return;

            const courseSelect = document.getElementById('courseSelect');
            courseSelect.innerHTML = '<option value="">เลือกรายวิชา</option>';

            // กรองรายวิชาตามชื่ออาจารย์
            const professorCourses = courseData.filter(course => 
                course.instructor.includes(username) || 
                course.instructor === username ||
                // สำหรับการสาธิต อนุญาตให้อาจารย์เข้าถึงรายวิชาทั้งหมด
                true
            );

            // เพิ่มรายวิชาลงใน dropdown
            professorCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.code;
                option.textContent = `${course.code} - ${course.name}`;
                courseSelect.appendChild(option);
            });
        }

        // ฟังก์ชันเรียกใช้การอัปโหลดไฟล์
        function triggerFileUpload(semester) {
            // ตรวจสอบว่าได้เลือกรายวิชาแล้วหรือไม่
            if (!currentCourse) {
                alert('กรุณาเลือกรายวิชาก่อน');
                return;
            }
            // เรียกใช้ input file ที่ซ่อนไว้
            document.getElementById(`fileInput-${semester}`).click();
        }

        // ฟังก์ชันจัดการการอัปโหลดไฟล์ Excel
        function handleFileUpload(event, semester) {
            const file = event.target.files[0]; // ไฟล์ที่เลือก
            if (!file) return; // ถ้าไม่มีไฟล์ให้หยุด

            const reader = new FileReader(); // สร้าง FileReader สำหรับอ่านไฟล์
            reader.onload = function(e) {
                try {
                    // แปลงข้อมูลไฟล์เป็น array buffer
                    const data = new Uint8Array(e.target.result);
                    // อ่านไฟล์ Excel ด้วย XLSX library
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0]; // ใช้ sheet แรก
                    const worksheet = workbook.Sheets[sheetName];
                    // แปลงข้อมูลเป็น JSON array
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // ประมวลผลข้อมูล Excel
                    processExcelData(jsonData, semester);
                } catch (error) {
                    alert('เกิดข้อผิดพลาดในการอ่านไฟล์ Excel: ' + error.message);
                }
            };
            // อ่านไฟล์เป็น array buffer
            reader.readAsArrayBuffer(file);
        }

        // ฟังก์ชันประมวลผลข้อมูล Excel และแปลงคะแนนเป็นเกรด
        function processExcelData(data, semester) {
            console.log('Excel data:', data); // บันทึกข้อมูลสำหรับ debug
            
            // ตรวจสอบว่าไฟล์มีข้อมูลเพียงพอหรือไม่
            if (data.length < 2) {
                alert('ไฟล์ Excel ต้องมีอย่างน้อย 2 แถว (หัวตารางและข้อมูล)');
                return;
            }

            let updatedCount = 0; // นับจำนวนนักศึกษาที่อัปเดตเกรดสำเร็จ
            
            // รูปแบบไฟล์ Excel ที่คาดหวัง:
            // คอลัมน์ A: ลำดับ (1, 2, 3, ...)
            // คอลัมน์ B: ชื่อนักศึกษา
            // คอลัมน์ C: คะแนน (ตัวเลข)
            
            // ข้ามแถวหัวตาราง (แถวที่ 0) และประมวลผลข้อมูลแถวอื่นๆ
            for (let row = 1; row < data.length; row++) {
                const rowData = data[row]; // ข้อมูลในแถวปัจจุบัน
                
                // ข้ามแถวที่ไม่มีข้อมูลครบ
                if (!rowData || rowData.length < 3) continue;
                
                const no = rowData[0]; // คอลัมน์ A: ลำดับ
                const name = rowData[1]; // คอลัมน์ B: ชื่อ
                const score = rowData[2]; // คอลัมน์ C: คะแนน
                
                console.log(`Row ${row}: No=${no}, Name=${name}, Score=${score}`); // บันทึกข้อมูลสำหรับ debug
                
                // ข้ามแถวที่ไม่มีชื่อหรือคะแนน
                if (!name || score === undefined || score === null || score === '') continue;
                
                // ทำความสะอาดชื่อ (ลบช่องว่างส่วนเกิน)
                const cleanName = String(name).trim();
                
                // ใช้ลำดับแถวเพื่อจับคู่กับรายชื่อนักศึกษา
                const studentIndex = row - 1; // ลบ 1 เพราะแถวหัวตาราง
                
                // ตรวจสอบว่าลำดับนี้อยู่ในช่วงที่ถูกต้องหรือไม่
                if (studentIndex >= 0 && studentIndex < currentCourse.students.length) {
                    const student = currentCourse.students[studentIndex];
                    
                    // แปลงคะแนนเป็นเกรด
                    const grade = convertScoreToGrade(score);
                    student.grades[semester] = grade; // บันทึกเกรด
                    updatedCount++; // เพิ่มจำนวนที่อัปเดตสำเร็จ
                    console.log(`Updated ${student.studentId} - ${student.name}: ${score} -> ${grade}`);
                } else {
                    console.log(`Row ${row} is out of range for student list`);
                }
            }

            // แสดงผลลัพธ์การอัปเดต
            if (updatedCount > 0) {
                alert(`อัปเดตเกรดสำเร็จ: ${updatedCount} คน`);
                renderStudentTable(); // อัปเดตตาราง
                updateGradeStatistics(); // อัปเดตสถิติ
            } else {
                alert('ไม่พบข้อมูลนักศึกษาที่ตรงกัน กรุณาตรวจสอบชื่อนักศึกษาในไฟล์ Excel\n\nรูปแบบที่ถูกต้อง:\nคอลัมน์ A: ลำดับ (1, 2, 3, ...)\nคอลัมน์ B: ชื่อนักศึกษา\nคอลัมน์ C: คะแนน');
            }

            // ล้างค่า input file
            document.getElementById(`fileInput-${semester}`).value = '';
        }

        // ฟังก์ชันแปลงคะแนนตัวเลขเป็นเกรดตัวอักษร
        function convertScoreToGrade(score) {
            const numScore = parseFloat(score); // แปลงเป็นตัวเลข
            
            // ถ้าไม่ใช่ตัวเลขให้เกรด F
            if (isNaN(numScore)) return 'F';
            
            // เกณฑ์การให้เกรด
            if (numScore >= 80) return 'A';   // 80-100
            if (numScore >= 75) return 'B+';  // 75-79
            if (numScore >= 70) return 'B';   // 70-74
            if (numScore >= 65) return 'C+';  // 65-69
            if (numScore >= 60) return 'C';   // 60-64
            if (numScore >= 55) return 'D+';  // 55-59
            if (numScore >= 50) return 'D';   // 50-54
            return 'F'; // ต่ำกว่า 50
        }

        // ฟังก์ชันโหลดรายชื่อนักศึกษาสำหรับรายวิชาที่เลือก
        // หน้าที่: แสดงรายชื่อนักศึกษาและเตรียมส่วนต่างๆ ของหน้าเว็บเมื่อเลือกรายวิชา
        // การทำงาน: ดึงข้อมูลรายวิชา อัปเดตการแสดงผล และเรียกฟังก์ชันที่เกี่ยวข้อง
        function loadStudentList() {
            // ดึงรหัสวิชาที่เลือกจาก dropdown
            const courseCode = document.getElementById('courseSelect').value;
            
            // ตรวจสอบว่าได้เลือกรายวิชาหรือไม่
            if (!courseCode) {
                // ถ้าไม่ได้เลือก ให้ซ่อนส่วนแสดงรายชื่อนักศึกษาและสถิติเกรด
                document.getElementById('studentGradeSection').classList.add('hidden');
                document.getElementById('gradeStatsSection').classList.add('hidden');
                return; // หยุดการทำงานของฟังก์ชัน
            }

            // ค้นหาข้อมูลรายวิชาจากรหัสวิชาที่เลือก
            currentCourse = courseData.find(course => course.code === courseCode);
            if (!currentCourse) return; // ถ้าไม่พบรายวิชา ให้หยุดการทำงาน

            // อัปเดตชื่อวิชาในหัวตาราง
            document.getElementById('courseTitle').textContent = 
                `${currentCourse.code} - ${currentCourse.name}`;
            // อัปเดตรายละเอียดวิชา (Section, ห้องเรียน, อาจารย์ผู้สอน)
            document.getElementById('courseDetails').textContent = 
                `Section ${currentCourse.section} | ห้อง ${currentCourse.room} | อาจารย์ ${currentCourse.instructor}`;

            // อัปเดตจำนวนนักศึกษาทั้งหมดในรายวิชา
            document.getElementById('totalStudents').textContent = currentCourse.students.length;

            // เรียกฟังก์ชันสร้างตารางแสดงรายชื่อนักศึกษา
            renderStudentTable();

            // แสดงส่วนตารางนักศึกษาและส่วนสถิติเกรด
            document.getElementById('studentGradeSection').classList.remove('hidden');
            document.getElementById('gradeStatsSection').classList.remove('hidden');

            // อัปเดตสถิติการกระจายเกรด
            updateGradeStatistics();
        }

        // ฟังก์ชันสร้างตารางแสดงรายชื่อนักศึกษา
        // หน้าที่: สร้างและแสดงตารางรายชื่อนักศึกษาพร้อม dropdown สำหรับเลือกเกรด
        // การทำงาน: วนลูปผ่านรายชื่อนักศึกษาและสร้าง HTML สำหรับแต่ละแถว
        function renderStudentTable() {
            // ตรวจสอบว่ามีรายวิชาที่เลือกหรือไม่
            if (!currentCourse) return;

            // ดึง element ของ tbody ในตาราง
            const tbody = document.getElementById('studentTableBody');
            // ล้างเนื้อหาเดิมในตาราง
            tbody.innerHTML = '';

            // วนลูปผ่านรายชื่อนักศึกษาทั้งหมดในรายวิชา
            currentCourse.students.forEach((student, index) => {
                // สร้างแถวใหม่สำหรับนักศึกษาแต่ละคน
                const row = document.createElement('tr');
                // เพิ่ม CSS class สำหรับ hover effect
                row.className = 'hover:bg-gray-50';
                
                // สร้าง HTML สำหรับแถวนักศึกษา
                row.innerHTML = `
                    <td class="border p-3">${index + 1}</td>
                    <td class="border p-3 font-mono">${student.studentId}</td>
                    <td class="border p-3">${student.name}</td>
                    <td class="border p-3 text-center">
                        <select class="grade-input w-20 p-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-green-500" 
                                data-student-id="${student.studentId}" 
                                data-semester="semester1"
                                onchange="updateGrade(this)">
                            <option value="">-</option>
                            <option value="A" ${student.grades.semester1 === 'A' ? 'selected' : ''}>A</option>
                            <option value="B+" ${student.grades.semester1 === 'B+' ? 'selected' : ''}>B+</option>
                            <option value="B" ${student.grades.semester1 === 'B' ? 'selected' : ''}>B</option>
                            <option value="C+" ${student.grades.semester1 === 'C+' ? 'selected' : ''}>C+</option>
                            <option value="C" ${student.grades.semester1 === 'C' ? 'selected' : ''}>C</option>
                            <option value="D+" ${student.grades.semester1 === 'D+' ? 'selected' : ''}>D+</option>
                            <option value="D" ${student.grades.semester1 === 'D' ? 'selected' : ''}>D</option>
                            <option value="F" ${student.grades.semester1 === 'F' ? 'selected' : ''}>F</option>
                        </select>
                    </td>
                    <td class="border p-3 text-center">
                        <select class="grade-input w-20 p-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-green-500" 
                                data-student-id="${student.studentId}" 
                                data-semester="semester2"
                                onchange="updateGrade(this)">
                            <option value="">-</option>
                            <option value="A" ${student.grades.semester2 === 'A' ? 'selected' : ''}>A</option>
                            <option value="B+" ${student.grades.semester2 === 'B+' ? 'selected' : ''}>B+</option>
                            <option value="B" ${student.grades.semester2 === 'B' ? 'selected' : ''}>B</option>
                            <option value="C+" ${student.grades.semester2 === 'C+' ? 'selected' : ''}>C+</option>
                            <option value="C" ${student.grades.semester2 === 'C' ? 'selected' : ''}>C</option>
                            <option value="D+" ${student.grades.semester2 === 'D+' ? 'selected' : ''}>D+</option>
                            <option value="D" ${student.grades.semester2 === 'D' ? 'selected' : ''}>D</option>
                            <option value="F" ${student.grades.semester2 === 'F' ? 'selected' : ''}>F</option>
                        </select>
                    </td>
                `;
                
                // เพิ่มแถวที่สร้างเข้าไปในตาราง
                tbody.appendChild(row);
            });
        }

        // ฟังก์ชันอัปเดตเกรดเมื่อมีการเปลี่ยนแปลง
        // หน้าที่: บันทึกเกรดใหม่เมื่อผู้ใช้เลือกเกรดจาก dropdown
        // การทำงาน: ดึงข้อมูลจาก dropdown แล้วอัปเดตข้อมูลนักศึกษาและสถิติ
        // พารามิเตอร์: selectElement - element ของ dropdown ที่ถูกเปลี่ยนแปลง
        function updateGrade(selectElement) {
            // ดึงรหัสนักศึกษาจาก data attribute
            const studentId = selectElement.dataset.studentId;
            // ดึงภาคเรียนจาก data attribute (semester1 หรือ semester2)
            const semester = selectElement.dataset.semester;
            // ดึงเกรดที่เลือกจาก dropdown
            const grade = selectElement.value;

            // ตรวจสอบว่ามีรายวิชาที่เลือกหรือไม่
            if (!currentCourse) return;

            // ค้นหานักศึกษาจากรหัสนักศึกษา
            const student = currentCourse.students.find(s => s.studentId === studentId);
            if (student) {
                // บันทึกเกรดใหม่ลงในข้อมูลนักศึกษา
                student.grades[semester] = grade;
                // อัปเดตสถิติเกรดทันที
                updateGradeStatistics();
            }
        }

        // ฟังก์ชันอัปเดตสถิติการกระจายเกรด
        // หน้าที่: คำนวณและแสดงจำนวนนักศึกษาที่ได้เกรดแต่ละระดับ
        // การทำงาน: นับจำนวนเกรดแต่ละประเภทและอัปเดตการแสดงผลในส่วนสถิติ
        function updateGradeStatistics() {
            // ตรวจสอบว่ามีรายวิชาที่เลือกหรือไม่
            if (!currentCourse) return;

            // ดึงภาคเรียนที่เลือกจาก dropdown
            const selectedSemester = document.getElementById('semesterSelect').value;
            // สร้าง array ของเกรดทั้งหมดในภาคเรียนที่เลือก (กรองเฉพาะที่มีเกรด)
            const grades = currentCourse.students.map(student => student.grades[selectedSemester]).filter(grade => grade);

            // สร้าง object สำหรับนับจำนวนเกรดแต่ละประเภท
            const gradeCount = {
                'A': 0, 'B+': 0, 'B': 0, 'C+': 0, 'C': 0, 'D+': 0, 'D': 0, 'F': 0
            };

            // วนลูปนับจำนวนเกรดแต่ละประเภท
            grades.forEach(grade => {
                if (gradeCount.hasOwnProperty(grade)) {
                    gradeCount[grade]++; // เพิ่มจำนวนเกรดนั้นๆ
                }
            });

            // อัปเดตการแสดงผลจำนวนเกรดแต่ละประเภทในหน้าเว็บ
            document.getElementById('gradeA').textContent = gradeCount['A'];
            document.getElementById('gradeBPlus').textContent = gradeCount['B+'];
            document.getElementById('gradeB').textContent = gradeCount['B'];
            document.getElementById('gradeCPlus').textContent = gradeCount['C+'];
            document.getElementById('gradeC').textContent = gradeCount['C'];
            document.getElementById('gradeDPlus').textContent = gradeCount['D+'];
            document.getElementById('gradeD').textContent = gradeCount['D'];
            document.getElementById('gradeF').textContent = gradeCount['F'];
        }

        // ฟังก์ชันอัปเดตคอลัมนเกรดตามภาคเรียนที่เลือก
        // หน้าที่: เปลี่ยนการแสดงสถิติเกรดเมื่อผู้ใช้เปลี่ยนภาคเรียน
        // การทำงาน: อัปเดตตัวแปร currentSemester และเรียกฟังก์ชันอัปเดตสถิติ
        function updateGradeColumns() {
            // อัปเดตภาคเรียนปัจจุบันตามที่ผู้ใช้เลือก
            currentSemester = document.getElementById('semesterSelect').value;
            // อัปเดตสถิติเกรดใหม่ตามภาคเรียนที่เลือก
            updateGradeStatistics();
        }

        // ฟังก์ชันบันทึกเกรดทั้งหมด
        // หน้าที่: บันทึกเกรดทั้งหมดของนักศึกษาในรายวิชา (สำหรับระบบจริง)
        // การทำงาน: ตรวจสอบว่ามีรายวิชาที่เลือก แล้วแสดงข้อความยืนยัน
        function saveAllGrades() {
            // ตรวจสอบว่าได้เลือกรายวิชาแล้วหรือไม่
            if (!currentCourse) {
                alert('กรุณาเลือกรายวิชาก่อน');
                return;
            }

            // ในระบบจริงจะส่งข้อมูลไปยังเซิร์ฟเวอร์
            alert('บันทึกเกรดเรียบร้อยแล้ว');
        }

        // ฟังก์ชันส่งออกข้อมูลเกรด
        // หน้าที่: ส่งออกข้อมูลเกรดเป็นไฟล์ (สำหรับระบบจริง)
        // การทำงาน: ตรวจสอบว่ามีรายวิชาที่เลือก แล้วแสดงข้อความแจ้งเตือน
        function exportGrades() {
            // ตรวจสอบว่าได้เลือกรายวิชาแล้วหรือไม่
            if (!currentCourse) {
                alert('กรุณาเลือกรายวิชาก่อน');
                return;
            }

            // ในระบบจริงจะสร้างและดาวน์โหลดไฟล์
            alert('ฟีเจอร์ส่งออกข้อมูลจะพัฒนาในอนาคต');
        }

        // ฟังก์ชันจัดการการพิมพ์
        // หน้าที่: เปิดหน้าต่างพิมพ์ของเบราว์เซอร์
        // การทำงาน: เรียกใช้ฟังก์ชัน window.print() ของเบราว์เซอร์
        function handlePrint() {
            window.print(); // เปิดหน้าต่างพิมพ์
        }

        // ฟังก์ชันจัดการการดาวน์โหลด PDF
        // หน้าที่: ดาวน์โหลดหน้าเว็บเป็นไฟล์ PDF (สำหรับระบบจริง)
        // การทำงาน: แสดงข้อความแจ้งเตือนว่าฟีเจอร์ยังไม่พร้อมใช้งาน
        function handleDownload() {
            alert('ฟีเจอร์ดาวน์โหลด PDF จะพัฒนาในอนาคต');
        }

        // ฟังก์ชันนำทางไปหน้าต่างๆ
        // หน้าที่: จัดการนำทางไปยังหน้าต่างๆ ในระบบ
        // การทำงาน: ตรวจสอบหน้าที่ต้องการไปและดำเนินการตามนั้น
        // พารามิเตอร์: page - ชื่อหน้าที่ต้องการนำทางไป
        function navigateTo(page) {
            if (page === 'profile') {
                // หน้าโปรไฟล์ยังไม่พร้อมใช้งาน
                alert('หน้าโปรไฟล์อยู่ระหว่างการพัฒนา');
            }
        }

        // ฟังก์ชันออกจากระบบ
        // หน้าที่: จัดการการออกจากระบบของผู้ใช้
        // การทำงาน: ยืนยันการออกจากระบบ ลบข้อมูลจาก localStorage และนำทางกลับหน้าหลัก
        function logout() {
            // ยืนยันการออกจากระบบ
            if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
                // ลบข้อมูลการล็อกอินทั้งหมดจาก localStorage
                localStorage.removeItem('userType');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('selectedInstructor');
                // นำทางกลับไปหน้าหลัก
                window.location.href = 'mainpage.html';
            }
        }

        // ฟังก์ชันเริ่มต้น dropdown และเมนูมือถือ
        // หน้าที่: ตั้งค่า event listener สำหรับ dropdown โปรไฟล์และเมนูมือถือ
        // การทำงาน: เพิ่ม event listener สำหรับการคลิกและจัดการการแสดง/ซ่อนเมนู
        function initializeDropdowns() {
            // ตั้งค่า Profile dropdown
            const profileDropdownBtn = document.getElementById('profileDropdownBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            
            // ตรวจสอบว่า element มีอยู่จริง
            if (profileDropdownBtn && profileDropdown) {
                // เพิ่ม event listener สำหรับการคลิกปุ่มโปรไฟล์
                profileDropdownBtn.addEventListener('click', (e) => {
                    e.preventDefault(); // ป้องกันการ refresh หน้า
                    profileDropdown.classList.toggle('hidden'); // สลับการแสดง/ซ่อน dropdown
                });

                // ปิด dropdown เมื่อคลิกที่อื่น
                document.addEventListener('click', (e) => {
                    // ตรวจสอบว่าคลิกนอกพื้นที่ dropdown หรือไม่
                    if (!profileDropdownBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden'); // ซ่อน dropdown
                    }
                });
            }

            // ตั้งค่าเมนูมือถือ
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            const menuIcon = document.getElementById('menuIcon');
            const closeIcon = document.getElementById('closeIcon');
            let isMenuOpen = false; // ตัวแปรเก็บสถานะเมนู

            // ตรวจสอบว่า element มีอยู่จริง
            if (mobileMenuBtn) {
                // เพิ่ม event listener สำหรับการคลิกปุ่มเมนูมือถือ
                mobileMenuBtn.addEventListener('click', () => {
                    isMenuOpen = !isMenuOpen; // สลับสถานะเมนู
                    
                    if (isMenuOpen) {
                        // แสดงเมนูและเปลี่ยนไอคอน
                        mobileMenu.classList.remove('hidden');
                        menuIcon.classList.add('hidden');
                        closeIcon.classList.remove('hidden');
                    } else {
                        // ซ่อนเมนูและเปลี่ยนไอคอน
                        mobileMenu.classList.add('hidden');
                        menuIcon.classList.remove('hidden');
                        closeIcon.classList.add('hidden');
                    }
                });
            }
        }

        // ฟังก์ชันตั้งค่าปีปัจจุบันใน footer
        // หน้าที่: แสดงปีปัจจุบันในส่วน copyright ของ footer
        // การทำงาน: ดึงปีปัจจุบันจากระบบและแสดงใน element ที่กำหนด
        function setCurrentYear() {
            const currentYearElement = document.getElementById('currentYear');
            if (currentYearElement) {
                // ตั้งค่าปีปัจจุบัน
                currentYearElement.textContent = new Date().getFullYear();
            }
        }

        // ฟังก์ชันเริ่มต้นหน้าเว็บ
        // หน้าที่: เรียกใช้ฟังก์ชันต่างๆ ที่จำเป็นเมื่อหน้าเว็บโหลดเสร็จ
        // การทำงาน: ตรวจสอบการล็อกอิน โหลดข้อมูล และเริ่มต้นส่วนประกอบต่างๆ
        function init() {
            // ตรวจสอบสถานะการล็อกอิน หากไม่ผ่านให้หยุดการทำงาน
            if (!checkLoginStatus()) return;
            
            // โหลดรายวิชาที่อาจารย์สอน
            loadProfessorCourses();
            // เริ่มต้น dropdown และเมนูต่างๆ
            initializeDropdowns();
            // ตั้งค่าปีปัจจุบัน
            setCurrentYear();
            // เริ่มต้นไอคอน Lucide
            lucide.createIcons();
        }

        // เรียกใช้ฟังก์ชันเริ่มต้นเมื่อหน้าเว็บโหลดเสร็จ
        // Event listener นี้จะรอให้ DOM โหลดเสร็จก่อนเรียกใช้ฟังก์ชัน init
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>